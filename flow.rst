Flow
====


The User Directory is used to publish encryption keys for applications. The diagram below shows its interaction 
with other parts of a cloud storage infrastructure.


.. image:: https://raw.githubusercontent.com/tarekziade/fxakeys/master/fxakeys.jpg


The flow is the following:

- A user connects to their FxA account with Application through an OAuth2 flow. 
- Application gets through this flow an authorization token it can trade for a bearer token 
- The token can be used to connect to the Storage service and to the Key service
- The FxA auth can also be used to generate a key pair for the application
- The public key generated by the application is published into the Key service
- The application can use the Key service to discover other users keys and encrypt data

Open questions, blockers:

- Both services need to be **FxA providers** if we want the same token to be used to authenticate to them
- The application in this diagram is a client-side application. Can it still provide a return URL for the OAuth2 flow ?
- To be able to share the key pair across devices, we have 2 options: 
  1/ encrypt the private key and publish it into the key server
  2/ derive the private key directly from kb so one device may regenerate it 
  the brainstorming is happening here: https://etherpad.mozilla.org/rRbsvxu1oL
- what happens to the data that's encrypted when the key changes ? (product question)



